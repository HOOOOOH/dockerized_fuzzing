<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - trace.lcov_info_final - orthrus/apetag.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">orthrus</a> - apetag.c<span style="font-size: 80%;"> (source / <a href="apetag.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">trace.lcov_info_final</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">252</td>
            <td class="headerCovTableEntry">401</td>
            <td class="headerCovTableEntryLo">62.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2019-09-05 12:03:35</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">10</td>
            <td class="headerCovTableEntry">12</td>
            <td class="headerCovTableEntryMed">83.3 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : #include &quot;apetag.h&quot;</a>
<span class="lineNum">       2 </span>            : #include &quot;mp3gain.h&quot;
<span class="lineNum">       3 </span>            : #include &quot;rg_error.h&quot;
<span class="lineNum">       4 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">       5 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">       6 </span>            : #include &lt;memory.h&gt;
<span class="lineNum">       7 </span>            : #include &lt;string.h&gt;
<span class="lineNum">       8 </span>            : #include &lt;fcntl.h&gt;
<span class="lineNum">       9 </span>            : #ifdef WIN32
<span class="lineNum">      10 </span>            : #include &lt;io.h&gt;
<span class="lineNum">      11 </span>            : #else
<span class="lineNum">      12 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      13 </span>            : #endif
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : #ifndef WIN32
<span class="lineNum">      16 </span>            : #define _stricmp strcasecmp
<a name="17"><span class="lineNum">      17 </span>            : #endif /* WIN32 */</a>
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span><span class="lineCov">        861 : int ReadMP3ID3v1Tag(FILE *fi, unsigned char **tagbuff, long *tag_offset) {</span>
<span class="lineNum">      20 </span>            :     char tmp[128];
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span><span class="lineCov">        861 :         if ( *tag_offset &lt; 128 ) return 0;</span>
<span class="lineNum">      23 </span><span class="lineCov">        790 :         if ( fseek(fi, *tag_offset - 128,SEEK_SET) ) return 0;</span>
<span class="lineNum">      24 </span><span class="lineCov">        790 :         if ( fread(tmp, 1, 128, fi) != 128 ) return 0;</span>
<span class="lineNum">      25 </span><span class="lineCov">        790 :     if ( memcmp (tmp, &quot;TAG&quot;, 3) ) return 0;</span>
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            :     //we have tag, so store it in buffer
<span class="lineNum">      28 </span><span class="lineCov">          8 :         if (*tagbuff)</span>
<span class="lineNum">      29 </span><span class="lineCov">          8 :                 free(*tagbuff);</span>
<span class="lineNum">      30 </span><span class="lineCov">          8 :         *tagbuff = (unsigned char *)malloc(128);</span>
<span class="lineNum">      31 </span><span class="lineCov">          8 :     memcpy(*tagbuff,tmp,128);</span>
<span class="lineNum">      32 </span><span class="lineCov">          8 :     *tag_offset -= 128;</span>
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span><span class="lineCov">          8 :     return 1;</span>
<span class="lineNum">      35 </span>            : }
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : /*
<span class="lineNum">      39 </span>            : static int Lyrics3GetNumber5 ( const unsigned char* string )
<span class="lineNum">      40 </span>            : {
<span class="lineNum">      41 </span>            :         return ( string[0] - '0') * 10000 +
<span class="lineNum">      42 </span>            :                    ( string[1] - '0') * 1000 +
<span class="lineNum">      43 </span>            :                    ( string[2] - '0') * 100 +
<span class="lineNum">      44 </span>            :                    ( string[3] - '0') * 10 +
<span class="lineNum">      45 </span>            :                    ( string[4] - '0') * 1;
<span class="lineNum">      46 </span>            : }
<span class="lineNum">      47 </span>            : */
<a name="48"><span class="lineNum">      48 </span>            : </a>
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span><span class="lineNoCov">          0 : static int Lyrics3GetNumber6 ( const unsigned char* string )</span>
<span class="lineNum">      51 </span>            : {
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :         if (string[0] &lt; '0' || string[0] &gt; '9') return 0;</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :         if (string[1] &lt; '0' || string[1] &gt; '9') return 0;</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :         if (string[2] &lt; '0' || string[2] &gt; '9') return 0;</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :         if (string[3] &lt; '0' || string[3] &gt; '9') return 0;</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :         if (string[4] &lt; '0' || string[4] &gt; '9') return 0;</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :         if (string[5] &lt; '0' || string[5] &gt; '9') return 0;</span>
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :         return ( string[0] - '0') * 100000 +</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :                    ( string[1] - '0') * 10000 +</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :                    ( string[2] - '0') * 1000 +</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :                    ( string[3] - '0') * 100 +</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :                    ( string[4] - '0') * 10 +</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :                    ( string[5] - '0') * 1;</span>
<span class="lineNum">      64 </span>            : }
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            : struct Lyrics3TagFooterStruct {
<span class="lineNum">      67 </span>            :     unsigned char   Length  [6];
<span class="lineNum">      68 </span>            :     unsigned char   ID      [9];
<span class="lineNum">      69 </span>            : };
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            : struct Lyrics3TagField {
<span class="lineNum">      72 </span>            :         unsigned char   ID      [3];
<span class="lineNum">      73 </span>            :         unsigned char   Length  [5];
<span class="lineNum">      74 </span>            : };
<a name="75"><span class="lineNum">      75 </span>            : </a>
<span class="lineNum">      76 </span>            : // Reads Lyrics3 v2.0 tag
<span class="lineNum">      77 </span><span class="lineCov">        861 : static int ReadMP3Lyrics3v2Tag ( FILE *fp, unsigned char **tagbuff, unsigned long *tagSize, unsigned char **id3tagbuff, long *tag_offset )</span>
<span class="lineNum">      78 </span>            : {
<span class="lineNum">      79 </span>            :         int                                 len;
<span class="lineNum">      80 </span>            :         struct Lyrics3TagFooterStruct       T;
<span class="lineNum">      81 </span>            :     char                                tmpid3[128];
<span class="lineNum">      82 </span>            :     char                                tmp[11];
<span class="lineNum">      83 </span>            :     long                                taglen;
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineCov">        861 :         if ( *tag_offset &lt; 128 ) return 0;</span>
<span class="lineNum">      86 </span><span class="lineCov">        790 :     if ( fseek (fp, *tag_offset - 128, SEEK_SET) ) return 0;</span>
<span class="lineNum">      87 </span><span class="lineCov">        790 :     if ( fread (tmpid3, 1, 128, fp) != 128 ) return 0;</span>
<span class="lineNum">      88 </span>            :     // check for id3-tag
<span class="lineNum">      89 </span><span class="lineCov">        790 :     if ( memcmp (tmpid3, &quot;TAG&quot;, 3) ) return 0;</span>
<span class="lineNum">      90 </span>            :     //if we have id3-tag, put it in the id3tagbuff
<span class="lineNum">      91 </span><span class="lineCov">          8 :         if (*id3tagbuff)</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :                 free(*id3tagbuff);</span>
<span class="lineNum">      93 </span><span class="lineCov">          8 :         *id3tagbuff = (unsigned char *)malloc(128);</span>
<span class="lineNum">      94 </span><span class="lineCov">          8 :     memcpy(*id3tagbuff,tmpid3,128);</span>
<span class="lineNum">      95 </span><span class="lineCov">          8 :         if ( *tag_offset &lt; (128 + (long)(sizeof(T))) ) return 0;</span>
<span class="lineNum">      96 </span><span class="lineCov">          4 :     if ( fseek (fp, *tag_offset - 128 - sizeof (T), SEEK_SET) ) return 0;</span>
<span class="lineNum">      97 </span><span class="lineCov">          4 :     if ( fread (&amp;T, 1, sizeof (T), fp) != sizeof (T) ) return 0;</span>
<span class="lineNum">      98 </span>            :     // check for lyrics3 v2.00 tag
<span class="lineNum">      99 </span><span class="lineCov">          4 :     if ( memcmp (T.ID, &quot;LYRICS200&quot;, sizeof (T.ID)) ) return 0;</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :         len = Lyrics3GetNumber6 (T.Length);</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :         if (*tag_offset &lt; (128 + (long)(sizeof(T)) + len)) return 0;</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :         if ( fseek (fp, *tag_offset - 128 - (long)sizeof (T) - len, SEEK_SET) ) return 0;</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :     if ( fread  (tmp, 1, 11, fp) != 11 ) return 0;</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :     if ( memcmp (tmp, &quot;LYRICSBEGIN&quot;, 11) ) return 0;</span>
<span class="lineNum">     105 </span>            :     
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :     taglen = 128 + Lyrics3GetNumber6(T.Length) + sizeof(T);</span>
<span class="lineNum">     107 </span>            :     
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :     *tag_offset -= taglen;</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :     if (*tagbuff != NULL) {</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :         free(*tagbuff);</span>
<span class="lineNum">     111 </span>            :     }
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     *tagbuff = (unsigned char *)malloc(taglen);</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     fseek(fp,*tag_offset,SEEK_SET);</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :     fread(*tagbuff,1,taglen,fp);</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :         *tagSize = taglen;</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">     117 </span>            : }
<a name="118"><span class="lineNum">     118 </span>            : </a>
<span class="lineNum">     119 </span>            : 
<span class="lineNum">     120 </span><span class="lineCov">       3633 : static unsigned long Read_LE_Uint32_unsigned ( const unsigned char* p )</span>
<span class="lineNum">     121 </span>            : {
<span class="lineNum">     122 </span><span class="lineCov">      10899 :     return ((unsigned long)p[0] &lt;&lt;  0) |</span>
<span class="lineNum">     123 </span><span class="lineCov">       7266 :            ((unsigned long)p[1] &lt;&lt;  8) |</span>
<span class="lineNum">     124 </span><span class="lineCov">       3633 :            ((unsigned long)p[2] &lt;&lt; 16) |</span>
<span class="lineNum">     125 </span><span class="lineCov">       3633 :            ((unsigned long)p[3] &lt;&lt; 24);</span>
<a name="126"><span class="lineNum">     126 </span>            : }</a>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineCov">       3633 : static unsigned long Read_LE_Uint32 ( const char* p ) {return Read_LE_Uint32_unsigned((const unsigned char*)p);}</span>
<a name="129"><span class="lineNum">     129 </span>            : </a>
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span><span class="lineCov">       2581 : static void Write_LE_Uint32 ( char* p, const unsigned long value )</span>
<span class="lineNum">     132 </span>            : {
<span class="lineNum">     133 </span><span class="lineCov">       2581 :     p[0] = (unsigned char) (value &gt;&gt;  0);</span>
<span class="lineNum">     134 </span><span class="lineCov">       2581 :     p[1] = (unsigned char) (value &gt;&gt;  8);</span>
<span class="lineNum">     135 </span><span class="lineCov">       2581 :     p[2] = (unsigned char) (value &gt;&gt; 16);</span>
<span class="lineNum">     136 </span><span class="lineCov">       2581 :     p[3] = (unsigned char) (value &gt;&gt; 24);</span>
<span class="lineNum">     137 </span><span class="lineCov">       2581 : }</span>
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span>            : enum {
<span class="lineNum">     140 </span>            :         MAX_FIELD_SIZE = 1024*1024 //treat bigger fields as errors
<a name="141"><span class="lineNum">     141 </span>            : };</a>
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span><span class="lineCov">       1097 : unsigned long strlen_max(const char * ptr, unsigned long max) {</span>
<span class="lineNum">     144 </span><span class="lineCov">       1097 :         unsigned long n = 0;</span>
<span class="lineNum">     145 </span><span class="lineCov">       1097 :         while (ptr[n] &amp;&amp; n &lt; max) n++;</span>
<span class="lineNum">     146 </span><span class="lineCov">       1097 :         return n;</span>
<span class="lineNum">     147 </span>            : }
<a name="148"><span class="lineNum">     148 </span>            : </a>
<span class="lineNum">     149 </span>            : // Reads APE v1.0/2.0 tag
<span class="lineNum">     150 </span><span class="lineCov">        861 : int ReadMP3APETag ( FILE *fp,  struct MP3GainTagInfo *info, struct APETagStruct **apeTag, long *tag_offset )</span>
<span class="lineNum">     151 </span>            : {
<span class="lineNum">     152 </span>            :     unsigned long               vsize;
<span class="lineNum">     153 </span>            :     unsigned long               isize;
<span class="lineNum">     154 </span>            :     unsigned long               flags;
<span class="lineNum">     155 </span>            :         unsigned long                           remaining;
<span class="lineNum">     156 </span>            :     char*                       buff;
<span class="lineNum">     157 </span>            :     char*                       p;
<span class="lineNum">     158 </span>            :     char*                       value;
<span class="lineNum">     159 </span>            :     char*                       vp;
<span class="lineNum">     160 </span>            :     char*                       end;
<span class="lineNum">     161 </span>            :     struct APETagFooterStruct   T;
<span class="lineNum">     162 </span>            :     unsigned long               TagLen;
<span class="lineNum">     163 </span>            :     unsigned long               TagCount;
<span class="lineNum">     164 </span>            :     unsigned long               origTagCount, otherFieldsCount;
<span class="lineNum">     165 </span>            :     unsigned long               curFieldNum;
<span class="lineNum">     166 </span>            :     unsigned long               Ver;
<span class="lineNum">     167 </span>            :     char*                       name;
<span class="lineNum">     168 </span>            :     int                         is_info;
<span class="lineNum">     169 </span>            :         char                                            tmpString[10];
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineCov">        861 :         if ( *tag_offset &lt; (long)(sizeof(T)) ) return 0;</span>
<span class="lineNum">     172 </span><span class="lineCov">        836 :     if ( fseek(fp,*tag_offset - sizeof(T),SEEK_SET) ) return 0;</span>
<span class="lineNum">     173 </span><span class="lineCov">        836 :     if ( fread (&amp;T, 1, sizeof(T), fp) != sizeof(T) ) return 0;</span>
<span class="lineNum">     174 </span><span class="lineCov">        836 :     if ( memcmp (T.ID, &quot;APETAGEX&quot;, sizeof(T.ID)) ) return 0;</span>
<span class="lineNum">     175 </span><span class="lineCov">        356 :     Ver = Read_LE_Uint32 (T.Version);</span>
<span class="lineNum">     176 </span><span class="lineCov">        356 :     if ( (Ver != 1000) &amp;&amp; (Ver != 2000) ) return 0;</span>
<span class="lineNum">     177 </span><span class="lineCov">        340 :     if ( (TagLen = Read_LE_Uint32 (T.Length)) &lt; sizeof (T) ) return 0;</span>
<span class="lineNum">     178 </span><span class="lineCov">        336 :         if (*tag_offset &lt; TagLen) return 0;</span>
<span class="lineNum">     179 </span><span class="lineCov">        332 :     if ( fseek (fp, *tag_offset - TagLen, SEEK_SET) ) return 0;</span>
<span class="lineNum">     180 </span><span class="lineCov">        332 :     buff = (char *)malloc (TagLen);</span>
<span class="lineNum">     181 </span><span class="lineCov">        332 :     if ( fread (buff, 1, TagLen - sizeof (T), fp) != (TagLen - sizeof (T)) ) {</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :         free (buff);</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     184 </span>            :     }
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span><span class="lineCov">        332 :     if (*apeTag) {</span>
<span class="lineNum">     187 </span><span class="lineCov">         52 :         if ((*apeTag)-&gt;otherFields)</span>
<span class="lineNum">     188 </span><span class="lineCov">         52 :             free((*apeTag)-&gt;otherFields);</span>
<span class="lineNum">     189 </span><span class="lineCov">         52 :                 free(*apeTag);</span>
<span class="lineNum">     190 </span>            :     }
<span class="lineNum">     191 </span><span class="lineCov">        332 :         *apeTag = (struct APETagStruct *)malloc(sizeof(struct APETagStruct));</span>
<span class="lineNum">     192 </span><span class="lineCov">        332 :         (*apeTag)-&gt;haveHeader = 0;</span>
<span class="lineNum">     193 </span><span class="lineCov">        332 :         (*apeTag)-&gt;otherFields = (unsigned char *)malloc(TagLen - sizeof(T));</span>
<span class="lineNum">     194 </span><span class="lineCov">        332 :     (*apeTag)-&gt;otherFieldsSize = 0;</span>
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span><span class="lineCov">        332 :         memcpy(&amp;((*apeTag)-&gt;footer),&amp;T,sizeof(T));</span>
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span><span class="lineCov">        332 :     origTagCount = TagCount = Read_LE_Uint32 (T.TagCount);</span>
<span class="lineNum">     199 </span><span class="lineCov">        332 :     otherFieldsCount = 0;</span>
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineCov">        332 :     end = buff + TagLen - sizeof (T);</span>
<span class="lineNum">     203 </span><span class="lineCov">        332 :         curFieldNum = 0;</span>
<span class="lineNum">     204 </span><span class="lineCov">       1624 :     for ( p = buff; p &lt; end &amp;&amp; TagCount--; ) {</span>
<span class="lineNum">     205 </span><span class="lineCov">       1098 :                 if (end - p &lt; 8) break;</span>
<span class="lineNum">     206 </span><span class="lineCov">       1097 :         vsize = Read_LE_Uint32 (p); p += 4;</span>
<span class="lineNum">     207 </span><span class="lineCov">       1097 :         flags = Read_LE_Uint32 (p); p += 4;</span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineCov">       1097 :                 remaining = (unsigned long) (end - p);</span>
<span class="lineNum">     210 </span><span class="lineCov">       1097 :         isize = strlen_max (p, remaining);</span>
<span class="lineNum">     211 </span><span class="lineCov">       1097 :                 if (isize &gt;= remaining || vsize &gt; MAX_FIELD_SIZE || isize + 1 + vsize &gt; remaining) break;</span>
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span><span class="lineCov">        960 :         name = (char*)malloc(isize+1);</span>
<span class="lineNum">     214 </span><span class="lineCov">        960 :                 memcpy(name, p, isize);</span>
<span class="lineNum">     215 </span><span class="lineCov">        960 :                 name[isize] = 0;</span>
<span class="lineNum">     216 </span><span class="lineCov">        960 :         value = (char*)malloc(vsize+1);</span>
<span class="lineNum">     217 </span><span class="lineCov">        960 :         memcpy(value, p+isize+1, vsize);</span>
<span class="lineNum">     218 </span><span class="lineCov">        960 :         value[vsize] = 0;</span>
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span><span class="lineCov">        960 :                 is_info = 0;</span>
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span>            :                 {
<span class="lineNum">     223 </span><span class="lineCov">        960 :             if (!_stricmp (name, &quot;REPLAYGAIN_TRACK_GAIN&quot;)) {</span>
<span class="lineNum">     224 </span><span class="lineCov">        186 :                 info-&gt;haveTrackGain = !0;</span>
<span class="lineNum">     225 </span><span class="lineCov">        186 :                 info-&gt;trackGain = atof(value);</span>
<span class="lineNum">     226 </span><span class="lineCov">        774 :             } else if (!_stricmp(name,&quot;REPLAYGAIN_TRACK_PEAK&quot;)) {</span>
<span class="lineNum">     227 </span><span class="lineCov">        192 :                 info-&gt;haveTrackPeak = !0;</span>
<span class="lineNum">     228 </span><span class="lineCov">        192 :                 info-&gt;trackPeak = atof(value);</span>
<span class="lineNum">     229 </span><span class="lineCov">        582 :             } else if (!_stricmp(name,&quot;REPLAYGAIN_ALBUM_GAIN&quot;)) {</span>
<span class="lineNum">     230 </span><span class="lineCov">         12 :                 info-&gt;haveAlbumGain = !0;</span>
<span class="lineNum">     231 </span><span class="lineCov">         12 :                 info-&gt;albumGain = atof(value);</span>
<span class="lineNum">     232 </span><span class="lineCov">        570 :             } else if (!_stricmp(name,&quot;REPLAYGAIN_ALBUM_PEAK&quot;)) {</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :                 info-&gt;haveAlbumPeak = !0;</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :                 info-&gt;albumPeak = atof(value);</span>
<span class="lineNum">     235 </span><span class="lineCov">        570 :             } else if (!_stricmp(name,&quot;MP3GAIN_UNDO&quot;)) {</span>
<span class="lineNum">     236 </span>            :                                 /* value should be something like &quot;+003,+003,W&quot; */
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                 info-&gt;haveUndo = !0;</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :                 vp = value;</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :                                 memcpy(tmpString,vp,4);</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :                                 tmpString[4] = '\0';</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :                 info-&gt;undoLeft = atoi(tmpString);</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :                 vp = vp + 5; /* skip the comma, too */</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :                                 memcpy(tmpString,vp,4);</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :                                 tmpString[4] = '\0';</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :                 info-&gt;undoRight = atoi(tmpString);</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :                 vp = vp + 5; /* skip the comma, too */</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :                 if ((*vp == 'w')||(*vp == 'W')) {</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :                     info-&gt;undoWrap = !0;</span>
<span class="lineNum">     249 </span>            :                 } else {
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :                     info-&gt;undoWrap = 0;</span>
<span class="lineNum">     251 </span>            :                 }
<span class="lineNum">     252 </span><span class="lineCov">        570 :             } else if (!_stricmp(name,&quot;MP3GAIN_MINMAX&quot;)) {</span>
<span class="lineNum">     253 </span>            :                                 /* value should be something like &quot;001,153&quot; */
<span class="lineNum">     254 </span><span class="lineCov">        207 :                 info-&gt;haveMinMaxGain = !0;</span>
<span class="lineNum">     255 </span><span class="lineCov">        207 :                 vp = value;</span>
<span class="lineNum">     256 </span><span class="lineCov">        207 :                                 memcpy(tmpString,vp,3);</span>
<span class="lineNum">     257 </span><span class="lineCov">        207 :                                 tmpString[3] = '\0';</span>
<span class="lineNum">     258 </span><span class="lineCov">        207 :                 info-&gt;minGain = atoi(tmpString);</span>
<span class="lineNum">     259 </span><span class="lineCov">        207 :                 vp = vp + 4; /* skip the comma, too */</span>
<span class="lineNum">     260 </span><span class="lineCov">        207 :                                 memcpy(tmpString,vp,3);</span>
<span class="lineNum">     261 </span><span class="lineCov">        207 :                                 tmpString[3] = '\0';</span>
<span class="lineNum">     262 </span><span class="lineCov">        207 :                 info-&gt;maxGain = atoi(tmpString);</span>
<span class="lineNum">     263 </span><span class="lineCov">        363 :             } else if (!_stricmp(name,&quot;MP3GAIN_ALBUM_MINMAX&quot;)) {</span>
<span class="lineNum">     264 </span>            :                                 /* value should be something like &quot;001,153&quot; */
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :                 info-&gt;haveAlbumMinMaxGain = !0;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :                 vp = value;</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :                                 memcpy(tmpString,vp,3);</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :                                 tmpString[3] = '\0';</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :                 info-&gt;albumMinGain = atoi(tmpString);</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :                 vp = vp + 4; /* skip the comma, too */</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :                                 memcpy(tmpString,vp,3);</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :                                 tmpString[3] = '\0';</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :                 info-&gt;albumMaxGain = atoi(tmpString);</span>
<span class="lineNum">     274 </span>            :             } else {
<span class="lineNum">     275 </span><span class="lineCov">        363 :                 memcpy((*apeTag)-&gt;otherFields + (*apeTag)-&gt;otherFieldsSize, p - 8, 8 + isize + 1 + vsize);</span>
<span class="lineNum">     276 </span><span class="lineCov">        363 :                 (*apeTag)-&gt;otherFieldsSize += 8 + isize + 1 + vsize;</span>
<span class="lineNum">     277 </span><span class="lineCov">        363 :                 otherFieldsCount++;</span>
<span class="lineNum">     278 </span>            :             }
<span class="lineNum">     279 </span>            :                 }
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span>            :         if ( isize &gt; 0 &amp;&amp; vsize &gt; 0 ) {
<span class="lineNum">     282 </span>            :             if (is_info) {
<span class="lineNum">     283 </span>            :             } else {
<span class="lineNum">     284 </span>            :             }
<span class="lineNum">     285 </span>            :         }
<span class="lineNum">     286 </span><span class="lineCov">        960 :         free(value);</span>
<span class="lineNum">     287 </span><span class="lineCov">        960 :                 free(name);</span>
<span class="lineNum">     288 </span><span class="lineCov">        960 :         p += isize + 1 + vsize;</span>
<span class="lineNum">     289 </span>            :     }
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span><span class="lineCov">        332 :     free (buff);</span>
<span class="lineNum">     292 </span>            :     
<span class="lineNum">     293 </span><span class="lineCov">        332 :         *tag_offset -= TagLen;</span>
<span class="lineNum">     294 </span><span class="lineCov">        332 :         (*apeTag)-&gt;originalTagSize = TagLen;</span>
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineCov">        332 :     if ( Read_LE_Uint32 (T.Flags) &amp; (1&lt;&lt;31) ) {  // Tag contains header</span>
<span class="lineNum">     297 </span><span class="lineCov">        252 :                 if (*tag_offset &lt; (long)(sizeof(T))) return 0;</span>
<span class="lineNum">     298 </span><span class="lineCov">        248 :         *tag_offset -= sizeof (T);</span>
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span><span class="lineCov">        248 :                 fseek (fp, *tag_offset, SEEK_SET);</span>
<span class="lineNum">     301 </span><span class="lineCov">        248 :                 fread (&amp;((*apeTag)-&gt;header),1,sizeof(T),fp);</span>
<span class="lineNum">     302 </span><span class="lineCov">        248 :                 (*apeTag)-&gt;haveHeader = !0;</span>
<span class="lineNum">     303 </span><span class="lineCov">        248 :                 (*apeTag)-&gt;originalTagSize += sizeof(T);</span>
<span class="lineNum">     304 </span>            :         }
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineCov">        328 :     if (otherFieldsCount != origTagCount) {</span>
<span class="lineNum">     307 </span><span class="lineCov">        316 :          Write_LE_Uint32((*apeTag)-&gt;footer.Length, sizeof(T) + (*apeTag)-&gt;otherFieldsSize);</span>
<span class="lineNum">     308 </span><span class="lineCov">        316 :          Write_LE_Uint32((*apeTag)-&gt;footer.TagCount, otherFieldsCount);</span>
<span class="lineNum">     309 </span><span class="lineCov">        316 :          if ((*apeTag)-&gt;haveHeader) {</span>
<span class="lineNum">     310 </span><span class="lineCov">        240 :              Write_LE_Uint32((*apeTag)-&gt;header.Length, sizeof(T) + (*apeTag)-&gt;otherFieldsSize);</span>
<span class="lineNum">     311 </span><span class="lineCov">        240 :              Write_LE_Uint32((*apeTag)-&gt;header.TagCount, otherFieldsCount);</span>
<span class="lineNum">     312 </span>            :          }
<span class="lineNum">     313 </span>            :     }
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineCov">        328 :     return 1;</span>
<a name="316"><span class="lineNum">     316 </span>            : }</a>
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span><span class="lineCov">          5 : int truncate_file (char *filename, long truncLength) {</span>
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span>            : #ifdef WIN32
<span class="lineNum">     321 </span>            :     
<span class="lineNum">     322 </span>            :    int fh, result;
<span class="lineNum">     323 </span>            : 
<span class="lineNum">     324 </span>            :    /* Open a file */
<span class="lineNum">     325 </span>            :     if( (fh = _open(filename, _O_RDWR))  != -1 )
<span class="lineNum">     326 </span>            :     {
<span class="lineNum">     327 </span>            :         if( ( result = _chsize( fh, truncLength ) ) == 0 ) {
<span class="lineNum">     328 </span>            :             _close(fh);
<span class="lineNum">     329 </span>            :             return 1;
<span class="lineNum">     330 </span>            :         } else {
<span class="lineNum">     331 </span>            :             _close(fh);
<span class="lineNum">     332 </span>            :             return 0;
<span class="lineNum">     333 </span>            :         }
<span class="lineNum">     334 </span>            :    } else {
<span class="lineNum">     335 </span>            :        return 0;
<span class="lineNum">     336 </span>            :    }
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span>            : #else
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span>            :         int fd;
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineCov">          5 :         fd = open(filename, O_RDWR);</span>
<span class="lineNum">     343 </span><span class="lineCov">          5 :         if (fd &lt; 0)</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     345 </span><span class="lineCov">          5 :         if (ftruncate(fd, truncLength)) {</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :                 close(fd);</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :                 passError( MP3GAIN_UNSPECIFED_ERROR, 3, &quot;Could not truncate &quot;,</span>
<span class="lineNum">     348 </span>            :                         filename, &quot;\n&quot;);
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     350 </span>            :         }
<span class="lineNum">     351 </span><span class="lineCov">          5 :         close(fd);</span>
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span><span class="lineCov">          5 :         return 1;</span>
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            : #endif
<span class="lineNum">     356 </span>            : }
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span>            : /**
<span class="lineNum">     360 </span>            :  * Read gain information from an APE tag.
<span class="lineNum">     361 </span>            :  *
<span class="lineNum">     362 </span>            :  * Look for an APE tag at the end of the MP3 file, and extract
<span class="lineNum">     363 </span>            :  * gain information from it. Any ID3v1 or Lyrics3v2 tags at the end
<a name="364"><span class="lineNum">     364 </span>            :  * of the file are read and stored, but not processed.</a>
<span class="lineNum">     365 </span>            :  */
<span class="lineNum">     366 </span><span class="lineCov">        521 : int ReadMP3GainAPETag (char *filename, struct MP3GainTagInfo *info, struct FileTagsStruct *fileTags) {</span>
<span class="lineNum">     367 </span>            :     FILE *fi;
<span class="lineNum">     368 </span>            :     long tag_offset, offs_bk, file_size;
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineCov">        521 :     fi = fopen(filename, &quot;rb&quot;);</span>
<span class="lineNum">     371 </span><span class="lineCov">        521 :     if (fi == NULL)</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     373 </span>            :         
<span class="lineNum">     374 </span><span class="lineCov">        521 :         fseek(fi, 0, SEEK_END);</span>
<span class="lineNum">     375 </span><span class="lineCov">        521 :     tag_offset = file_size = ftell(fi);</span>
<span class="lineNum">     376 </span>            :         
<span class="lineNum">     377 </span><span class="lineCov">        521 :         fileTags-&gt;lyrics3TagSize = 0;</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span>            :     do {
<span class="lineNum">     380 </span><span class="lineCov">        861 :                 offs_bk = tag_offset;</span>
<span class="lineNum">     381 </span><span class="lineCov">        861 :                 ReadMP3APETag ( fi, info, &amp;(fileTags-&gt;apeTag), &amp;tag_offset );</span>
<span class="lineNum">     382 </span><span class="lineCov">        861 :         ReadMP3Lyrics3v2Tag ( fi, &amp;(fileTags-&gt;lyrics3tag), &amp;(fileTags-&gt;lyrics3TagSize), &amp;(fileTags-&gt;id31tag), &amp;tag_offset );</span>
<span class="lineNum">     383 </span><span class="lineCov">        861 :                 ReadMP3ID3v1Tag ( fi, &amp;(fileTags-&gt;id31tag), &amp;tag_offset );</span>
<span class="lineNum">     384 </span><span class="lineCov">        861 :         } while ( offs_bk != tag_offset );</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineCov">        521 :         if (tag_offset &gt;= 0 &amp;&amp; tag_offset &lt;= file_size) {</span>
<span class="lineNum">     387 </span><span class="lineCov">        521 :                 fileTags-&gt;tagOffset = tag_offset;</span>
<span class="lineNum">     388 </span>            :         } else { //Corrupt tag information, simply default to end-of-file
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :                 fileTags-&gt;tagOffset = file_size;</span>
<span class="lineNum">     390 </span>            :         }
<span class="lineNum">     391 </span>            : 
<span class="lineNum">     392 </span><span class="lineCov">        521 :     fclose(fi);</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineCov">        521 :     return 1;</span>
<span class="lineNum">     395 </span>            : };
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span>            : /**
<span class="lineNum">     399 </span>            :  * (Re-)Write gain information to an APEv2 tag.
<span class="lineNum">     400 </span>            :  *
<span class="lineNum">     401 </span>            :  * You need to have already called ReadMP3GainTag and filled in the info
<a name="402"><span class="lineNum">     402 </span>            :  * and fileTags structures.</a>
<span class="lineNum">     403 </span>            :  */
<span class="lineNum">     404 </span><span class="lineCov">        126 : int WriteMP3GainAPETag (char *filename, struct MP3GainTagInfo *info, struct FileTagsStruct *fileTags, int saveTimeStamp) {</span>
<span class="lineNum">     405 </span>            :         FILE *outputFile;
<span class="lineNum">     406 </span>            :         unsigned long newTagLength;
<span class="lineNum">     407 </span>            :         unsigned long newTagCount;
<span class="lineNum">     408 </span>            :         char *newFieldData;
<span class="lineNum">     409 </span>            :         char *mp3gainTagData;
<span class="lineNum">     410 </span>            :         unsigned long mp3gainTagLength;
<span class="lineNum">     411 </span>            :         char valueString[100];
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span>            :         struct APETagFooterStruct newFooter;
<span class="lineNum">     414 </span>            :         struct APETagFooterStruct newHeader;
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span><span class="lineCov">        126 :         if (saveTimeStamp)</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                 fileTime(filename, storeTime);</span>
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span>            :         /* For the new tag, we'll have a footer _AND_ header (whether or not a header was in the original */
<span class="lineNum">     420 </span><span class="lineCov">        126 :         newTagLength = sizeof(struct APETagFooterStruct) * 2;</span>
<span class="lineNum">     421 </span><span class="lineCov">        126 :         newTagCount = 0;</span>
<span class="lineNum">     422 </span><span class="lineCov">        126 :         mp3gainTagLength = 0;</span>
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineCov">        126 :         if (fileTags-&gt;apeTag) {</span>
<span class="lineNum">     425 </span>            :                 /* For the new tag, we'll have the non-MP3Gain fields from the original tag */
<span class="lineNum">     426 </span><span class="lineCov">         76 :                 newTagLength += fileTags-&gt;apeTag-&gt;otherFieldsSize;</span>
<span class="lineNum">     427 </span><span class="lineCov">         76 :                 newTagCount += Read_LE_Uint32(fileTags-&gt;apeTag-&gt;footer.TagCount);</span>
<span class="lineNum">     428 </span>            :         }
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span><span class="lineCov">        126 :         if (info-&gt;haveAlbumGain) {</span>
<span class="lineNum">     431 </span>            :                 /* 8 bytes + &quot;REPLAYGAIN_ALBUM_GAIN&quot; + '/0' + &quot;+2.456789 dB&quot; = 42 bytes */
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :                 mp3gainTagLength += 42;</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                 newTagCount++;</span>
<span class="lineNum">     434 </span>            :         }
<span class="lineNum">     435 </span><span class="lineCov">        126 :         if (info-&gt;haveAlbumPeak) {</span>
<span class="lineNum">     436 </span>            :                 /* 8 bytes + &quot;REPLAYGAIN_ALBUM_PEAK&quot; + '/0' + &quot;1.345678&quot; = 38 bytes */
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                 mp3gainTagLength += 38;</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                 newTagCount++;</span>
<span class="lineNum">     439 </span>            :         }
<span class="lineNum">     440 </span><span class="lineCov">        126 :         if (info-&gt;haveTrackGain) {</span>
<span class="lineNum">     441 </span>            :                 /* 8 bytes + &quot;REPLAYGAIN_TRACK_GAIN&quot; + '/0' + &quot;+2.456789 dB&quot; = 42 bytes */
<span class="lineNum">     442 </span><span class="lineCov">        126 :                 mp3gainTagLength += 42;</span>
<span class="lineNum">     443 </span><span class="lineCov">        126 :                 newTagCount++;</span>
<span class="lineNum">     444 </span>            :         }
<span class="lineNum">     445 </span><span class="lineCov">        126 :         if (info-&gt;haveTrackPeak) {</span>
<span class="lineNum">     446 </span>            :                 /* 8 bytes + &quot;REPLAYGAIN_TRACK_PEAK&quot; + '/0' + &quot;1.345678&quot; = 38 bytes */
<span class="lineNum">     447 </span><span class="lineCov">        126 :                 mp3gainTagLength += 38;</span>
<span class="lineNum">     448 </span><span class="lineCov">        126 :                 newTagCount++;</span>
<span class="lineNum">     449 </span>            :         }
<span class="lineNum">     450 </span><span class="lineCov">        126 :         if (info-&gt;haveMinMaxGain) {</span>
<span class="lineNum">     451 </span>            :                 /* 8 bytes + &quot;MP3GAIN_MINMAX&quot; + '/0' + &quot;123,123&quot; = 30 bytes */
<span class="lineNum">     452 </span><span class="lineCov">        126 :                 mp3gainTagLength += 30;</span>
<span class="lineNum">     453 </span><span class="lineCov">        126 :                 newTagCount++;</span>
<span class="lineNum">     454 </span>            :         }
<span class="lineNum">     455 </span><span class="lineCov">        126 :         if (info-&gt;haveAlbumMinMaxGain) {</span>
<span class="lineNum">     456 </span>            :                 /* 8 bytes + &quot;MP3GAIN_ALBUM_MINMAX&quot; + '/0' + &quot;123,123&quot; = 36 bytes */
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :                 mp3gainTagLength += 36;</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                 newTagCount++;</span>
<span class="lineNum">     459 </span>            :         }
<span class="lineNum">     460 </span><span class="lineCov">        126 :         if (info-&gt;haveUndo) {</span>
<span class="lineNum">     461 </span>            :                 /* 8 bytes + &quot;MP3GAIN_UNDO&quot; + '/0' + &quot;+123,+123,W&quot; = 32 bytes */
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                 mp3gainTagLength += 32;</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                 newTagCount++;</span>
<span class="lineNum">     464 </span>            :         }
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineCov">        126 :         newTagLength += mp3gainTagLength;</span>
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span><span class="lineCov">        126 :         newFieldData = (char *)malloc(newTagLength - (sizeof(newFooter) + sizeof(newHeader)));</span>
<span class="lineNum">     469 </span><span class="lineCov">        126 :         mp3gainTagData = newFieldData;</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span><span class="lineCov">        126 :         if (fileTags-&gt;apeTag) {</span>
<span class="lineNum">     472 </span>            :                 /* Check if the new tag will be shorter than the old tag */
<span class="lineNum">     473 </span><span class="lineCov">         76 :                 if (fileTags-&gt;apeTag-&gt;originalTagSize &gt; newTagLength) {</span>
<span class="lineNum">     474 </span>            :                         /* we'll need to truncate the file */
<span class="lineNum">     475 </span><span class="lineCov">          5 :             if (!truncate_file(filename, fileTags-&gt;tagOffset)) {</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     477 </span>            :             }
<span class="lineNum">     478 </span>            :                 }
<span class="lineNum">     479 </span><span class="lineCov">         76 :                 memcpy(&amp;newFooter,&amp;(fileTags-&gt;apeTag-&gt;footer),sizeof(newFooter));</span>
<span class="lineNum">     480 </span><span class="lineCov">         76 :                 Write_LE_Uint32(newFooter.Length, newTagLength - sizeof(newHeader));</span>
<span class="lineNum">     481 </span><span class="lineCov">         76 :                 Write_LE_Uint32(newFooter.TagCount, newTagCount);</span>
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span><span class="lineCov">         76 :                 if (fileTags-&gt;apeTag-&gt;haveHeader) {</span>
<span class="lineNum">     484 </span><span class="lineCov">         73 :                         memcpy(&amp;newHeader,&amp;(fileTags-&gt;apeTag-&gt;header), sizeof(newHeader));</span>
<span class="lineNum">     485 </span><span class="lineCov">         73 :                         Write_LE_Uint32(newHeader.Length, newTagLength - sizeof(newFooter));</span>
<span class="lineNum">     486 </span><span class="lineCov">         73 :                         Write_LE_Uint32(newHeader.TagCount, newTagCount);</span>
<span class="lineNum">     487 </span>            :                 } else {
<span class="lineNum">     488 </span><span class="lineCov">          3 :                         memcpy(newHeader.ID,&quot;APETAGEX&quot;,sizeof(newHeader.ID));</span>
<span class="lineNum">     489 </span><span class="lineCov">          3 :                         Write_LE_Uint32(newHeader.Version,2000);</span>
<span class="lineNum">     490 </span><span class="lineCov">          3 :                         Write_LE_Uint32(newHeader.Length, newTagLength - sizeof(newFooter));</span>
<span class="lineNum">     491 </span><span class="lineCov">          3 :                         Write_LE_Uint32(newHeader.TagCount,newTagCount);</span>
<span class="lineNum">     492 </span><span class="lineCov">          3 :                         Write_LE_Uint32(newHeader.Flags,1&lt;&lt;31 | 1&lt;&lt;29); /* tag has header, this _is_ the header */</span>
<span class="lineNum">     493 </span><span class="lineCov">          3 :                         memset(newHeader.Reserved,0,sizeof(newHeader.Reserved));</span>
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span>            :                         /* and don't forget to fix the footer so that it now shows that the tag has a header! */
<span class="lineNum">     496 </span><span class="lineCov">          3 :                         Write_LE_Uint32(newFooter.Flags, Read_LE_Uint32(newFooter.Flags) | 1&lt;&lt;31);</span>
<span class="lineNum">     497 </span>            :                 }
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span><span class="lineCov">         76 :                 if (fileTags-&gt;apeTag-&gt;otherFieldsSize) {</span>
<span class="lineNum">     500 </span><span class="lineCov">         38 :                         memcpy(newFieldData, fileTags-&gt;apeTag-&gt;otherFields, fileTags-&gt;apeTag-&gt;otherFieldsSize);</span>
<span class="lineNum">     501 </span><span class="lineCov">         38 :                         mp3gainTagData += fileTags-&gt;apeTag-&gt;otherFieldsSize;</span>
<span class="lineNum">     502 </span>            :                 }
<span class="lineNum">     503 </span>            :         } else { /* we don't already have an APE tag, so create one from scratch */
<span class="lineNum">     504 </span><span class="lineCov">         50 :                 memcpy(newHeader.ID,&quot;APETAGEX&quot;,sizeof(newHeader.ID));</span>
<span class="lineNum">     505 </span><span class="lineCov">         50 :                 Write_LE_Uint32(newHeader.Version,2000);</span>
<span class="lineNum">     506 </span><span class="lineCov">         50 :                 Write_LE_Uint32(newHeader.Length, newTagLength - sizeof(newFooter));</span>
<span class="lineNum">     507 </span><span class="lineCov">         50 :                 Write_LE_Uint32(newHeader.TagCount,newTagCount);</span>
<span class="lineNum">     508 </span><span class="lineCov">         50 :                 Write_LE_Uint32(newHeader.Flags,1&lt;&lt;31 | 1&lt;&lt;29); /* tag has header, this _is_ the header */</span>
<span class="lineNum">     509 </span><span class="lineCov">         50 :                 memset(newHeader.Reserved,0,sizeof(newHeader.Reserved));</span>
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span><span class="lineCov">         50 :                 memcpy(newFooter.ID,&quot;APETAGEX&quot;,sizeof(newFooter.ID));</span>
<span class="lineNum">     512 </span><span class="lineCov">         50 :                 Write_LE_Uint32(newFooter.Version,2000);</span>
<span class="lineNum">     513 </span><span class="lineCov">         50 :                 Write_LE_Uint32(newFooter.Length, newTagLength - sizeof(newHeader));</span>
<span class="lineNum">     514 </span><span class="lineCov">         50 :                 Write_LE_Uint32(newFooter.TagCount,newTagCount);</span>
<span class="lineNum">     515 </span><span class="lineCov">         50 :                 Write_LE_Uint32(newFooter.Flags,1&lt;&lt;31); /* tag has header */</span>
<span class="lineNum">     516 </span><span class="lineCov">         50 :                 memset(newFooter.Reserved,0,sizeof(newFooter.Reserved));</span>
<span class="lineNum">     517 </span>            :         }
<span class="lineNum">     518 </span>            :         
<span class="lineNum">     519 </span><span class="lineCov">        126 :         if (info-&gt;haveMinMaxGain) {</span>
<span class="lineNum">     520 </span>            :                 /* 8 bytes + &quot;MP3GAIN_MINMAX&quot; + '/0' + &quot;123,123&quot; = 30 bytes */
<span class="lineNum">     521 </span><span class="lineCov">        126 :                 Write_LE_Uint32(mp3gainTagData,7);</span>
<span class="lineNum">     522 </span><span class="lineCov">        126 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     523 </span><span class="lineCov">        126 :                 Write_LE_Uint32(mp3gainTagData,0);</span>
<span class="lineNum">     524 </span><span class="lineCov">        126 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     525 </span><span class="lineCov">        126 :                 strcpy(mp3gainTagData, &quot;MP3GAIN_MINMAX&quot;);</span>
<span class="lineNum">     526 </span><span class="lineCov">        126 :                 mp3gainTagData += 15;</span>
<span class="lineNum">     527 </span><span class="lineCov">        126 :                 sprintf(mp3gainTagData,&quot;%03d&quot;, info-&gt;minGain); /* write directly to tag buffer, because we'll replace the trailing null char anyhow */</span>
<span class="lineNum">     528 </span><span class="lineCov">        126 :                 mp3gainTagData[3] = ',';</span>
<span class="lineNum">     529 </span><span class="lineCov">        126 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     530 </span><span class="lineCov">        126 :                 sprintf(valueString,&quot;%03d&quot;, info-&gt;maxGain);</span>
<span class="lineNum">     531 </span><span class="lineCov">        126 :                 memcpy(mp3gainTagData, valueString, 3); /* DON'T write trailing null char */</span>
<span class="lineNum">     532 </span><span class="lineCov">        126 :                 mp3gainTagData += 3;</span>
<span class="lineNum">     533 </span>            :         }
<span class="lineNum">     534 </span><span class="lineCov">        126 :         if (info-&gt;haveAlbumMinMaxGain) {</span>
<span class="lineNum">     535 </span>            :                 /* 8 bytes + &quot;MP3GAIN_ALBUM_MINMAX&quot; + '/0' + &quot;123,123&quot; = 36 bytes */
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :                 Write_LE_Uint32(mp3gainTagData,7);</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :                 Write_LE_Uint32(mp3gainTagData,0);</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :                 strcpy(mp3gainTagData, &quot;MP3GAIN_ALBUM_MINMAX&quot;);</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 21;</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :                 sprintf(mp3gainTagData,&quot;%03d&quot;, info-&gt;albumMinGain); /* write directly to tag buffer, because we'll replace the trailing null char anyhow */</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :                 mp3gainTagData[3] = ',';</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :                 sprintf(valueString,&quot;%03d&quot;, info-&gt;albumMaxGain);</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :                 memcpy(mp3gainTagData, valueString, 3); /* DON'T write trailing null char */</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 3;</span>
<span class="lineNum">     548 </span>            :         }
<span class="lineNum">     549 </span><span class="lineCov">        126 :         if (info-&gt;haveUndo) {</span>
<span class="lineNum">     550 </span>            :                 /* 8 bytes + &quot;MP3GAIN_UNDO&quot; + '/0' + &quot;+234,+234,W&quot; = 32 bytes */
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :                 Write_LE_Uint32(mp3gainTagData,11);</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :                 Write_LE_Uint32(mp3gainTagData,0);</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :                 strcpy(mp3gainTagData, &quot;MP3GAIN_UNDO&quot;);</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 13;</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :                 sprintf(mp3gainTagData,&quot;%+04d&quot;, info-&gt;undoLeft); /* write directly to tag buffer, because we'll replace the trailing null char anyhow */</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :                 mp3gainTagData[4] = ',';</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 5;</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :                 sprintf(mp3gainTagData,&quot;%+04d&quot;, info-&gt;undoRight); /* write directly to tag buffer, because we'll replace the trailing null char anyhow */</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :                 mp3gainTagData[4] = ',';</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 5;</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :                 if (info-&gt;undoWrap) {</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :                         *mp3gainTagData = 'W';</span>
<span class="lineNum">     565 </span>            :                 } else {
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :                         *mp3gainTagData = 'N';</span>
<span class="lineNum">     567 </span>            :                 }
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :                 mp3gainTagData++;</span>
<span class="lineNum">     569 </span>            :         }
<span class="lineNum">     570 </span><span class="lineCov">        126 :         if (info-&gt;haveTrackGain) {</span>
<span class="lineNum">     571 </span>            :                 /* 8 bytes + &quot;REPLAYGAIN_TRACK_GAIN&quot; + '/0' + &quot;+2.456789 dB&quot; = 42 bytes */
<span class="lineNum">     572 </span><span class="lineCov">        126 :                 Write_LE_Uint32(mp3gainTagData,12);</span>
<span class="lineNum">     573 </span><span class="lineCov">        126 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     574 </span><span class="lineCov">        126 :                 Write_LE_Uint32(mp3gainTagData,0);</span>
<span class="lineNum">     575 </span><span class="lineCov">        126 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     576 </span><span class="lineCov">        126 :                 strcpy(mp3gainTagData, &quot;REPLAYGAIN_TRACK_GAIN&quot;);</span>
<span class="lineNum">     577 </span><span class="lineCov">        126 :                 mp3gainTagData += 22;</span>
<span class="lineNum">     578 </span><span class="lineCov">        126 :                 sprintf(valueString,&quot;%-+9.6f&quot;, info-&gt;trackGain);</span>
<span class="lineNum">     579 </span><span class="lineCov">        126 :                 memcpy(mp3gainTagData, valueString, 9);</span>
<span class="lineNum">     580 </span><span class="lineCov">        126 :                 mp3gainTagData += 9;</span>
<span class="lineNum">     581 </span><span class="lineCov">        126 :                 memcpy(mp3gainTagData, &quot; dB&quot;, 3);</span>
<span class="lineNum">     582 </span><span class="lineCov">        126 :                 mp3gainTagData += 3;</span>
<span class="lineNum">     583 </span>            :         }
<span class="lineNum">     584 </span><span class="lineCov">        126 :         if (info-&gt;haveTrackPeak) {</span>
<span class="lineNum">     585 </span>            :                 /* 8 bytes + &quot;REPLAYGAIN_TRACK_PEAK&quot; + '/0' + &quot;1.345678&quot; = 38 bytes */
<span class="lineNum">     586 </span><span class="lineCov">        126 :                 Write_LE_Uint32(mp3gainTagData,8);</span>
<span class="lineNum">     587 </span><span class="lineCov">        126 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     588 </span><span class="lineCov">        126 :                 Write_LE_Uint32(mp3gainTagData,0);</span>
<span class="lineNum">     589 </span><span class="lineCov">        126 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     590 </span><span class="lineCov">        126 :                 strcpy(mp3gainTagData, &quot;REPLAYGAIN_TRACK_PEAK&quot;);</span>
<span class="lineNum">     591 </span><span class="lineCov">        126 :                 mp3gainTagData += 22;</span>
<span class="lineNum">     592 </span><span class="lineCov">        126 :                 sprintf(valueString,&quot;%-8.6f&quot;, info-&gt;trackPeak);</span>
<span class="lineNum">     593 </span><span class="lineCov">        126 :                 memcpy(mp3gainTagData, valueString, 8);</span>
<span class="lineNum">     594 </span><span class="lineCov">        126 :                 mp3gainTagData += 8;</span>
<span class="lineNum">     595 </span>            :         }
<span class="lineNum">     596 </span><span class="lineCov">        126 :         if (info-&gt;haveAlbumGain) {</span>
<span class="lineNum">     597 </span>            :                 /* 8 bytes + &quot;REPLAYGAIN_ALBUM_GAIN&quot; + '/0' + &quot;+2.456789 dB&quot; = 42 bytes */
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                 Write_LE_Uint32(mp3gainTagData,12);</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                 Write_LE_Uint32(mp3gainTagData,0);</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :                 strcpy(mp3gainTagData, &quot;REPLAYGAIN_ALBUM_GAIN&quot;);</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 22;</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                 sprintf(valueString,&quot;%-+9.6f&quot;, info-&gt;albumGain);</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :                 memcpy(mp3gainTagData, valueString, 9);</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 9;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :                 memcpy(mp3gainTagData, &quot; dB&quot;, 3);</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 3;</span>
<span class="lineNum">     609 </span>            :         }
<span class="lineNum">     610 </span><span class="lineCov">        126 :         if (info-&gt;haveAlbumPeak) {</span>
<span class="lineNum">     611 </span>            :                 /* 8 bytes + &quot;REPLAYGAIN_ALBUM_PEAK&quot; + '/0' + &quot;1.345678&quot; = 38 bytes */
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :                 Write_LE_Uint32(mp3gainTagData,8);</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :                 Write_LE_Uint32(mp3gainTagData,0);</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 4;</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :                 strcpy(mp3gainTagData, &quot;REPLAYGAIN_ALBUM_PEAK&quot;);</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 22;</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :                 sprintf(valueString,&quot;%-8.6f&quot;, info-&gt;albumPeak);</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :                 memcpy(mp3gainTagData, valueString, 8);</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :                 mp3gainTagData += 8;</span>
<span class="lineNum">     621 </span>            :         }
<span class="lineNum">     622 </span>            : 
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span><span class="lineCov">        126 :         outputFile = fopen(filename,&quot;r+b&quot;);</span>
<span class="lineNum">     625 </span><span class="lineCov">        126 :         if (outputFile == NULL) {</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :                   passError( MP3GAIN_UNSPECIFED_ERROR, 3,</span>
<span class="lineNum">     627 </span>            :                           &quot;\nCan't open &quot;, filename, &quot; for modifying\n&quot;);
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     629 </span>            :         }
<span class="lineNum">     630 </span><span class="lineCov">        126 :         fseek(outputFile,fileTags-&gt;tagOffset,SEEK_SET);</span>
<span class="lineNum">     631 </span><span class="lineCov">        126 :         if (newTagCount &gt; 0) { /* write APE tag */</span>
<span class="lineNum">     632 </span><span class="lineCov">        126 :                 fwrite(&amp;newHeader,1,sizeof(newHeader),outputFile);</span>
<span class="lineNum">     633 </span><span class="lineCov">        126 :                 fwrite(newFieldData, 1, newTagLength - (sizeof(newFooter) + sizeof(newHeader)), outputFile);</span>
<span class="lineNum">     634 </span><span class="lineCov">        126 :                 fwrite(&amp;newFooter,1,sizeof(newFooter),outputFile);</span>
<span class="lineNum">     635 </span>            :         }
<span class="lineNum">     636 </span><span class="lineCov">        126 :         if (fileTags-&gt;lyrics3TagSize &gt; 0) {</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :                 fwrite(fileTags-&gt;lyrics3tag, 1, fileTags-&gt;lyrics3TagSize, outputFile);</span>
<span class="lineNum">     638 </span>            :         }
<span class="lineNum">     639 </span><span class="lineCov">        126 :     else if (fileTags-&gt;id31tag) { //by definition, Lyrics3 tag includes id3 tag,</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :                 fwrite(fileTags-&gt;id31tag, 1, 128, outputFile); //so only write id3 tag alone if</span>
<span class="lineNum">     641 </span>            :     }                                                  //no Lyrics3 tag
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineCov">        126 :         fclose(outputFile);</span>
<span class="lineNum">     644 </span>            :         
<span class="lineNum">     645 </span><span class="lineCov">        126 :         if (saveTimeStamp)</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :                 fileTime(filename,setStoredTime);</span>
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span><span class="lineCov">        126 :         free(newFieldData);</span>
<span class="lineNum">     649 </span><span class="lineCov">        126 :     return 1;</span>
<span class="lineNum">     650 </span>            : };
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span>            : 
<span class="lineNum">     653 </span>            : /**
<a name="654"><span class="lineNum">     654 </span>            :  * Remove gain information from the APE tag.</a>
<span class="lineNum">     655 </span>            :  */
<span class="lineNum">     656 </span><span class="lineNoCov">          0 : int RemoveMP3GainAPETag (char *filename, int saveTimeStamp) {</span>
<span class="lineNum">     657 </span>            :         struct MP3GainTagInfo info;
<span class="lineNum">     658 </span>            :         struct FileTagsStruct fileTags;
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :         info.dirty = 0;</span>
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :         info.haveAlbumGain = 0;</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :         info.haveAlbumPeak = 0;</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :         info.haveTrackGain = 0;</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :         info.haveTrackPeak = 0;</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :         info.haveMinMaxGain = 0;</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :         info.haveAlbumMinMaxGain = 0;</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :         info.haveUndo = 0;</span>
<span class="lineNum">     669 </span>            :     
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :     fileTags.apeTag = NULL;</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :     fileTags.id31tag = NULL;</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :     fileTags.lyrics3tag = NULL;</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :     fileTags.lyrics3TagSize = 0;</span>
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :         ReadMP3GainAPETag(filename, &amp;info, &amp;fileTags);</span>
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span>            : 
<span class="lineNum">     678 </span>            :         /* if any MP3Gain tags exist, then we're going to change the tag */
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :         if (info.haveAlbumGain || info.haveAlbumPeak || info.haveTrackGain || info.haveTrackPeak || info.haveMinMaxGain || info.haveAlbumMinMaxGain || info.haveUndo)</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :                 info.dirty = !0;</span>
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :         info.haveAlbumGain = 0;</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :         info.haveAlbumPeak = 0;</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :         info.haveTrackGain = 0;</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :         info.haveTrackPeak = 0;</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :         info.haveMinMaxGain = 0;</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :         info.haveAlbumMinMaxGain = 0;</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :         info.haveUndo = 0;</span>
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :         if (info.dirty)</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :                 WriteMP3GainAPETag(filename, &amp;info, &amp;fileTags, saveTimeStamp);</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">     694 </span>            : };
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
